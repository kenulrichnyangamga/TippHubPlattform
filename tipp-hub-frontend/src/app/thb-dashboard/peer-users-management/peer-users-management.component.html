<div class="container mt-4">
  <h3>Peer User Verwaltung</h3>

  <!-- Feedback Messages -->
  <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show">
    {{ successMessage }}
    <button type="button" class="btn-close" (click)="successMessage = ''"></button>
  </div>

 <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show">
  {{ errorMessage }}
  <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
</div>
  <!-- Search and Filter Section -->
  <div class="row mb-3">
    <div class="col-md-6">
      <input type="text" [(ngModel)]="searchTerm" 
             placeholder="Nutzer suchen (Name oder ID)" 
             class="form-control"
             (keyup.enter)="loadUsers()">
    </div>
    <div class="col-md-6">
      <select [(ngModel)]="selectedCommunityId" class="form-select" (change)="loadUsers()">
        <option [value]="null">Alle Communities</option>
        <option *ngFor="let c of communities" [value]="c.community_id">{{ c.name }}</option>
      </select>
    </div>
  </div>

  <!-- User List -->
  <div class="table-responsive">
    <table class="table table-hover">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Status</th>
          <th>Community</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of getFilteredUsers()">
          <td>{{ user.user_id }}</td>
          <td>{{ user.username }}</td>
          <td>
            <span [class.text-success]="user.status === 'aktiv'"
                  [class.text-danger]="user.status === 'gesperrt'">
              {{ user.status | titlecase }}
            </span>
          </td>
          <td>{{ user.community_name || '-' }}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <!-- Toggle Status Button -->
              <button (click)="toggleUserStatus(user)" 
                      class="btn"
                      [class.btn-warning]="user.status === 'aktiv'"
                      [class.btn-success]="user.status === 'gesperrt'">
                {{ user.status === 'aktiv' ? 'Sperren' : 'Freigeben' }}
              </button>

              <!-- Assign LCB Button -->
              <button *ngIf="selectedCommunityId"
                      (click)="assignAsLCB(user)"
                      class="btn btn-primary"
                      [disabled]="user.status === 'gesperrt' || user.role === 'LCB'">
                {{ user.role === 'LCB' ? 'Ist LCB' : 'Als LCB zuordnen' }}
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- LCB Assignment Modal -->
  <div class="modal fade" id="assignLCBModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">LCB Zuordnung</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" *ngIf="selectedUser">
          <p>Nutzer <strong>{{ selectedUser.username }}</strong> als LCB für Community zuordnen:</p>
          <select [(ngModel)]="selectedCommunityForAssignment" class="form-select">
            <option *ngFor="let c of communities" [value]="c.community_id">{{ c.name }}</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
          <button type="button" class="btn btn-primary" (click)="confirmLCBAssignment()">Bestätigen</button>
        </div>
      </div>
    </div>
  </div>
</div>
